<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UC Pool Co – Pool Builder</title>
    <!-- Tailwind via CDN for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen">
<div class="max-w-6xl mx-auto py-8 px-4">
    <!-- Header -->
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-slate-900">UC Pool Co – Pool Builder</h1>
        <p class="text-slate-600 mt-2">
            Enter your ZIP code to see available pools and estimated pricing for your area.
        </p>
    </header>

    <!-- ZIP section -->
    <section class="bg-white rounded-xl shadow p-4 mb-6">
        <form id="zipForm" class="flex flex-col gap-3 md:flex-row md:items-end">
            <div>
                <label for="zipInput" class="block text-sm font-medium text-slate-700">ZIP Code</label>
                <input id="zipInput" type="text" maxlength="10"
                       class="mt-1 block w-40 rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2"
                       placeholder="34491" required>
            </div>
            <button type="submit"
                    class="inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-700">
                Check ZIP & Load Pools
            </button>
        </form>
        <p id="zipStatus" class="mt-3 text-sm"></p>
    </section>

    <!-- Layout: Pools list + Cart -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Pools list -->
        <section class="lg:col-span-2 bg-white rounded-xl shadow p-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-slate-900">Available Pools</h2>
                <span id="currentZipLabel" class="text-sm text-slate-500"></span>
            </div>
            <div id="poolsContainer" class="grid sm:grid-cols-2 xl:grid-cols-3 gap-4">
                <p class="text-sm text-slate-500 col-span-full" id="poolsPlaceholder">
                    Enter a valid ZIP to load pool options.
                </p>
            </div>
        </section>

        <!-- Cart summary -->
        <section class="bg-white rounded-xl shadow p-4">
            <h2 class="text-xl font-semibold text-slate-900 mb-3">Your Cart</h2>
            <div id="cartContainer" class="text-sm text-slate-700">
                <p id="cartEmptyMsg" class="text-slate-500">Cart is empty.</p>
            </div>
            <div class="border-t mt-4 pt-4 text-sm">
                <div class="flex justify-between">
                    <span class="font-medium">Subtotal</span>
                    <span id="subtotalValue">$0.00</span>
                </div>
                <div class="flex justify-between">
                    <span>Shipping</span>
                    <span id="shippingValue">$0.00</span>
                </div>
                <div class="flex justify-between">
                    <span>Install</span>
                    <span id="installValue">$0.00</span>
                </div>
                <div class="flex justify-between">
                    <span>Permit</span>
                    <span id="permitValue">$0.00</span>
                </div>
                <div class="flex justify-between">
                    <span>Tax</span>
                    <span id="taxValue">$0.00</span>
                </div>
                <div class="flex justify-between mt-2 text-base font-semibold">
                    <span>Total</span>
                    <span id="grandTotalValue">$0.00</span>
                </div>
            </div>
            <button id="checkoutBtn"
                    class="mt-4 w-full inline-flex items-center justify-center rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-emerald-700 disabled:opacity-40 disabled:cursor-not-allowed"
                    disabled>
                Checkout (not wired to payments yet)
            </button>
        </section>
    </div>
</div>

<script>
    let currentZip = null;

    const zipForm = document.getElementById("zipForm");
    const zipInput = document.getElementById("zipInput");
    const zipStatus = document.getElementById("zipStatus");
    const currentZipLabel = document.getElementById("currentZipLabel");

    const poolsContainer = document.getElementById("poolsContainer");
    const poolsPlaceholder = document.getElementById("poolsPlaceholder");

    const cartContainer = document.getElementById("cartContainer");
    const cartEmptyMsg = document.getElementById("cartEmptyMsg");
    const subtotalValue = document.getElementById("subtotalValue");
    const shippingValue = document.getElementById("shippingValue");
    const installValue = document.getElementById("installValue");
    const permitValue = document.getElementById("permitValue");
    const taxValue = document.getElementById("taxValue");
    const grandTotalValue = document.getElementById("grandTotalValue");
    const checkoutBtn = document.getElementById("checkoutBtn");

    // Format currency helper
    function money(val) {
        if (val === undefined || val === null) return "$0.00";
        const num = Number(val);
        if (isNaN(num)) return String(val);
        return "$" + num.toFixed(2);
    }

    // Render cart from the cart JSON we already get from /api/cart/add-item/
    function renderCart(cart) {
        if (!cart || !cart.items || cart.items.length === 0) {
            cartContainer.innerHTML = "";
            cartEmptyMsg.textContent = "Cart is empty.";
            cartContainer.appendChild(cartEmptyMsg);
            subtotalValue.textContent = "$0.00";
            shippingValue.textContent = "$0.00";
            installValue.textContent = "$0.00";
            permitValue.textContent = "$0.00";
            taxValue.textContent = "$0.00";
            grandTotalValue.textContent = "$0.00";
            checkoutBtn.disabled = true;
            return;
        }

        cartContainer.innerHTML = "";
        cart.items.forEach(item => {
            const div = document.createElement("div");
            div.className = "border-b border-slate-200 pb-2 mb-2 last:border-b-0 last:pb-0 last:mb-0";
            const name = item.description || item.display_name || "Item";
            div.innerHTML = `
                <div class="flex justify-between">
                    <div>
                        <div class="font-medium">${name}</div>
                        <div class="text-xs text-slate-500">
                            Qty: ${item.quantity}
                            ${item.install_selected ? "· Install selected" : ""}
                        </div>
                    </div>
                    <div class="text-right">
                        <div>${money(item.line_subtotal)}</div>
                        <div class="text-xs text-slate-500">
                            Ship: ${money(item.line_shipping_amount)}<br>
                            Install: ${money(item.line_install_amount)}
                        </div>
                    </div>
                </div>
            `;
            cartContainer.appendChild(div);
        });

        subtotalValue.textContent = money(cart.totals?.subtotal);
        shippingValue.textContent = money(cart.totals?.shipping_total);
        installValue.textContent = money(cart.totals?.install_total);
        permitValue.textContent = money(cart.totals?.permit_total);
        taxValue.textContent = money(cart.totals?.tax_total);
        grandTotalValue.textContent = money(cart.totals?.grand_total);

        checkoutBtn.disabled = false;
    }

    async function checkZip(zip) {
        zipStatus.textContent = "Checking ZIP...";
        zipStatus.className = "mt-3 text-sm text-slate-600";

        try {
            const resp = await fetch("/api/builder/zip-check/", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({zip_code: zip})
            });
            const data = await resp.json();

            if (!data.ok) {
                zipStatus.textContent = data.error || "We do not currently service this ZIP code.";
                zipStatus.className = "mt-3 text-sm text-red-600";
                currentZip = null;
                currentZipLabel.textContent = "";
                poolsContainer.innerHTML = "";
                poolsPlaceholder.textContent = "No pools available – ZIP not serviceable.";
                poolsContainer.appendChild(poolsPlaceholder);
                return false;
            }

            currentZip = zip;
            currentZipLabel.textContent = `Pricing for ZIP ${zip}`;
            zipStatus.textContent = data.message || "ZIP is in our service area.";
            zipStatus.className = "mt-3 text-sm text-emerald-600";

            return true;
        } catch (err) {
            console.error(err);
            zipStatus.textContent = "Error checking ZIP. Please try again.";
            zipStatus.className = "mt-3 text-sm text-red-600";
            return false;
        }
    }

    async function loadPools() {
        poolsContainer.innerHTML = "";
        const loading = document.createElement("p");
        loading.className = "text-sm text-slate-500 col-span-full";
        loading.textContent = "Loading pool options…";
        poolsContainer.appendChild(loading);

        try {
            const resp = await fetch("/api/builder/pools/", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    zip_code: currentZip || null
                })
            });

            // If the server returned an HTML error page or non-JSON, this will throw
            let data;
            try {
                data = await resp.json();
            } catch (e) {
                console.error("Non-JSON response from /api/builder/pools/:", e);
                throw new Error("Invalid response from server.");
            }

            if (!resp.ok || !data.ok) {
                console.error("Pool API error:", data);
                poolsContainer.innerHTML = "";
                const p = document.createElement("p");
                p.className = "text-sm text-red-600 col-span-full";
                p.textContent = data.error || "Could not load pools for this ZIP.";
                poolsContainer.appendChild(p);
                return;
            }

            const pools = data.pools || [];
            if (pools.length === 0) {
                poolsContainer.innerHTML = "";
                const p = document.createElement("p");
                p.className = "text-sm text-slate-500 col-span-full";
                p.textContent = "No pool configurations are currently available for this area.";
                poolsContainer.appendChild(p);
                return;
            }

            poolsContainer.innerHTML = "";
            pools.forEach(pool => {
                const card = document.createElement("div");
                card.className = "border rounded-xl p-3 flex flex-col justify-between shadow-sm";

                const name = pool.display_name
                    || pool.name
                    || `${pool.series || "Pool"} – ${pool.size_label || ""}`;

                const price = pool.base_price || pool.price || pool.variant_price;

                card.innerHTML = `
                    <div class="mb-3">
                        <h3 class="text-sm font-semibold text-slate-900">${name}</h3>
                        <p class="text-xs text-slate-500 mt-1">
                            Series: ${pool.series || "N/A"}<br>
                            Size: ${pool.size_label || pool.size || "N/A"}
                        </p>
                        <p class="mt-2 text-base font-bold text-blue-700">
                            ${price ? money(price) : "Call for pricing"}
                        </p>
                    </div>
                    <div class="mt-auto flex flex-col gap-2">
                        <button class="w-full text-xs inline-flex items-center justify-center rounded-md border border-slate-300 px-3 py-1.5 font-medium text-slate-700 hover:bg-slate-50"
                                data-variant-id="${pool.id}" data-install="false">
                            Add Pool Only
                        </button>
                        <button class="w-full text-xs inline-flex items-center justify-center rounded-md bg-blue-600 px-3 py-1.5 font-medium text-white hover:bg-blue-700"
                                data-variant-id="${pool.id}" data-install="true">
                            Add Pool + Install
                        </button>
                    </div>
                `;

                const buttons = card.querySelectorAll("button[data-variant-id]");
                buttons.forEach(btn => {
                    btn.addEventListener("click", async (e) => {
                        const variantId = Number(e.currentTarget.dataset.variantId);
                        const install = e.currentTarget.dataset.install === "true";
                        await addPoolToCart(variantId, install);
                    });
                });

                poolsContainer.appendChild(card);
            });
        } catch (err) {
            console.error("Error loading pools:", err);
            poolsContainer.innerHTML = "";
            const p = document.createElement("p");
            p.className = "text-sm text-red-600 col-span-full";
            p.textContent = "Error loading pools.";
            poolsContainer.appendChild(p);
        }
    }

    async function addPoolToCart(variantId, installSelected) {
        if (!currentZip) {
            alert("Please enter and validate your ZIP first.");
            return;
        }

        try {
            const resp = await fetch("/api/cart/add-item/", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    zip_code: currentZip,
                    pool_variant_id: variantId,
                    quantity: 1,
                    install_selected: installSelected
                })
            });

            const data = await resp.json();
            if (!data.ok) {
                alert(data.error || "Could not add item to cart.");
                return;
            }

            // We already get the updated cart back
            renderCart(data.cart);
        } catch (err) {
            console.error(err);
            alert("Error adding item to cart.");
        }
    }

    zipForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const zip = zipInput.value.trim();
        if (!zip) return;

        const ok = await checkZip(zip);
        if (ok) {
            await loadPools();
        }
    });

    checkoutBtn.addEventListener("click", () => {
        alert("Checkout is wired on the backend ( /api/cart/checkout/ ) but not hooked to payments or this UI yet.\n\nRight now this page is for quoting / building only.");
    });
</script>
</body>
</html>
